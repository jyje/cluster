apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: open-webui
spec:
  project: ai
  source:
    repoURL: https://github.com/jyje/cluster
    targetRevision: main
    path: helm/open-webui-8.10.0
    helm:
      valueFiles:
        - values.yaml
      valuesObject:
        image:
          tag: "0.7"
          pullPolicy: "Always"
        ollama:
          enabled: false
        pipelines:
          enabled: false
        enableOpenaiApi: false
        ollamaUrls:
          - http://ollama:11434
        replicaCount: 3
        ingress:
          enabled: true
          class: nginx
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
            nginx.ingress.kubernetes.io/configuration-snippet: |
              more_set_headers "Access-Control-Allow-Origin: $http_origin";
            nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
            nginx.ingress.kubernetes.io/cors-allow-headers: X-Api-Key
            nginx.ingress.kubernetes.io/cors-allow-methods: HEAD
            nginx.ingress.kubernetes.io/enable-cors: "true"
            nginx.ingress.kubernetes.io/affinity: "cookie"
            nginx.ingress.kubernetes.io/session-cookie-name: "route"
            nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
            nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"
            nginx.ingress.kubernetes.io/proxy-body-size: "4096m"
          host: llm.app.jyje.online
          tls: true
          existingSecret: llm-letsencrypt-tls
        livenessProbe:
          httpGet:
            path: /health
            port: http
          failureThreshold: 3
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health/db
            port: http
          failureThreshold: 3
          periodSeconds: 10
        startupProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 5
          failureThreshold: 20
        persistence:
          enabled: true
          size: 10Gi
          accessModes:
            - ReadWriteMany
          storageClass: subdir-usb
        extraEnvVars:
          - name: OPENAI_API_BASE_URLS
            value: https://api.openai.com/v1;https://guest-api.sktax.chat/v1
          - name: OPENAI_API_KEYS
            valueFrom:
              secretKeyRef:
                name: openwebui-creds
                key: openai.api.key
          - name: VECTOR_DB
            value: milvus
          - name: MILVUS_URI
            valueFrom:
              secretKeyRef:
                name: openwebui-creds
                key: milvus.uri
          - name: MILVUS_DB
            value: owui
          - name: MILVUS_TOKEN
            valueFrom:
              secretKeyRef:
                name: openwebui-creds
                key: milvus.token
          - name: RAG_EMBEDDING_ENGINE
            value: openai
          - name: RAG_EMBEDDING_MODEL
            value: text-embedding-3-small
          - name: CORS_ALLOW_ORIGIN
            value: https://llm.app.jyje.online
          - name: USER_AGENT
            value: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36
          - name: REDIS_URL
            value: redis://open-webui-redis.ollama-system.svc.cluster.local:6379/0
          - name: ENABLE_WEBSOCKET_SUPPORT
            value: "True"
          - name: WEBSOCKET_MANAGER
            value: redis
          - name: WEBSOCKET_REDIS_URL
            value: redis://open-webui-redis.ollama-system.svc.cluster.local:6379/0
        extraResources:
          - apiVersion: bitnami.com/v1alpha1
            kind: SealedSecret
            metadata:
              name: openwebui-creds
            spec:
              encryptedData:
                milvus.token: AgBmez4OUxrv2El0uDe/2uzslaU2ofRWiS0v6FtRXLFS1ZiQDQdcSUMm/beBsxmq4OYBTFzmXOXnnju/YGefkW/PnGmWC3EPzBm2yzC74OB585khmqUGfLt8Ob3pO70TVBC5BnSQR3Mdupg9FziQlCjqJdniNdaBOz3i76ytv9f4Fg9/zj4fbUt+68YSUf5h60vs+L4s8ZAum5sU4ThQKkprZ0CZhL+OmV8zwnnnNxNlrRD8TME4w7vBCKf9QXvXP55+eCdh0Lk5fGTgyCoQf1BnKLN/NFuwGOaHqORPZWA6Z2Ol8E/EJ60aGfgDnUqd7bPTrfW/PkHB8jDqhTTL6QxgYfaiDuvh40pbwFSnhkaN1J6L4PNvavutH3fduPz+IUzBWhzgKZslXZuyF7Xxa70E8e8KQg27L8PQFhDxh8+UCAY4xXvDN+q/SdpC2j5Fe+WLdCUHclV3iyP1/18VknyztPnaTcICm03BVi5KEpaplgU08lwY40ucyDs43eyj4wwZURqEXe9RVcNyOLcZm/LsARtvQ/wr9lJ486ca+0Rsfx7EqNZwjy//UZZzi9CURs/AOq4AoPB2jrQc4YJskYHjwUetzC0NfnppFGG7m43zxpvD+dxBSPlWF9fNfIh0azjR7Pbwa5W9I+aKO3nibM2RnumxZEgvlZ1ySyWFyQOA+UuvjZpNs2NzMDRzsAszb8dV8TEQf/+tkORARPOt6CWjT7I=
                milvus.uri: AgBommm1CYyUd3flr/RYjP6X2Gx61Y4asQeRA0zOLGGNHqwYxYmITeXJYac7xnOzj1/dlA/iwwwhGgmB7OYydgrJmHz27jL7eUVuOI5f5J/WB2iRqsM4jbnEIhPwZcdfXgIwSTe4bqpDJ7yhQP7C+zUKZO8FEVIn4sqKhaANCmPK/VNkflQK2XlyAmn5zVkrDLOcgc2S5KxrcNqHcLOMyLzFBD5Sbh2SdVN3TinRR1j4XXcsGRpXaMLkFRsfNPt5Fyo3j70PhtTTTH4CpBHSIyHZgJWMH5hyqTb1XVHrQGSP8k1O4xI/OOulrtGQjK3SkZs5ZTYmd0bVOJHnawDBLEd8N/gT3bntyDQTRwpCZlNgu5GKQIk8TbH068XY83oDlkLrXGPT7l/dpret0gGDvZHLNrc08iyi5Dxai/r5grSiVhoK2xuXraK5UQpp+iMmCXFHtNVY/lZDx8Klv6U8wbp6jESyicmsi7EDdcyGw6RBtSKxFfACda6EDcuO70udeHvX5DBcE336Mah4eqNZMraXnj0ClReXaR+yR+vIgg0gZqqsDFrDsoF+4bz8+s2y0s2Omg5HY3A99RfphRZod2Rz/BOnwM4Kr89HzyQkTrFBPOd0OZ01mELL5l3u+UWsLjCphthRIfyX+W9hTEffRzy00UoVb2nbrQ6fXYedzFS3onazgqkAT2tb8h8l0FBoLrBX76GIXWbJ4eYmhuYK23dRoIpJ6y6X4ioaJIormCGgUC8l9zZmoYZF9gtv7poj26G0BjM=
                openai.api.key: AgAjwX2IuqZfc9oF8Mzt1T5zrgOHw/ryVySOtrO9YsJYVWJVH3K0O8vq3kL9dBDNBGzgAB9t0nW0paspSI3SAdkNBJ9OS7ekeeFplrQuLYD66eItUY86TCO2onWTw9sUATJ8nO3ty6ssFJh3bKriYh8LevOSE/n9J+zkZFv66A/EWFsXD/kUxntmm6yutjTqnkVbyAWlVb9EMtNY6FjCR5//gswKiBNOt20vCaxvht/TLlkPdL6gXtHoIXh1/OlyvmQhGTSzbrKa9+zj9oXblLhp5Ue2DCvCwFRQV45VSBFj9EiZpTnID6OBHJxFoVHwTwyWQxKDMMqY8ZzrIZiFTC0aCK1LxfA/W43mLl7nYa5aQGwdQHhorDU40WKt83g4noLu3PAcQL3K8mqTj1z1AQTIlGbTRmYHBxKnNDHlfF0O1z+QZ6g/D5rqMz3sBxCPdDd+5Wp0zKOz1x8/nN2Zc+wpE/XuXmEhdeAPseKJKO2mRWHOM2OQpjNnd7Z7WRHmGV5/pwF475TeJb7xWuQ49jpOSLD8Opy5x2P/TipZHMZupFiiA6NmYB/2XFdXj4bcZPXksjXwKv6ISKpmGKeTdEjgkCipZu5nMcONEeuLdPldh/BS2G01BOYw0eS6SPg5RBlNxLsV6chCoQNredTTz1buaZOJn7eGEB2wQNiP/OCK0NLlQ/EDNQmE9SVWUQdJ0TANmqv2Huow2n2gN1q4LWaFCqFoCkxwQzBfZaZfhSD85wWJpx/nv/MsBpp5auD7478FXX9PgYE+xPTfOthwBIvF9n1DNW47+5DTRidrvMcG6TNg6sphJzjye7K42fdTvLUrnwvFZwmV0/Qw981wqQTyjT5GBS+pyUZIB539YTUPp7qiGI7JAPwFTuUWtzMxd+mq16Hmop6c2sE95dW3G+Xc+t/0W0A1EJdDwKfZarchlvarJjB4uOvr1+ePH9tnvrbZrZ773Q==
              template:
                metadata:
                  name: openwebui-creds
                type: Opaque
        websocket:
          enabled: true
        #   url: redis://open-webui-redis-master:6379/0
        #   redis:
        #     enabled: false
        # redis-cluster:
        #   enabled: true
  destination:
    namespace: ollama-system
    server: 'https://kubernetes.default.svc'
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated: {}
