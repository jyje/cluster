apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: open-webui
spec:
  project: ai
  source:
    repoURL: https://github.com/jyje/cluster
    targetRevision: main
    path: helm/open-webui-6.6.0
    helm:
      valueFiles:
        - values.yaml
      valuesObject:
        image:
          tag: "0.6"
          pullPolicy: "Always"
        ollama:
          enabled: false
        pipelines:
          enabled: false
        ollamaUrls:
          - http://ollama:11434
        replicaCount: 3
        ingress:
          enabled: true
          class: nginx
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
            nginx.ingress.kubernetes.io/configuration-snippet: |
              more_set_headers "Access-Control-Allow-Origin: $http_origin";
            nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
            nginx.ingress.kubernetes.io/cors-allow-headers: X-Api-Key
            nginx.ingress.kubernetes.io/cors-allow-methods: HEAD
            nginx.ingress.kubernetes.io/enable-cors: "true"
            nginx.ingress.kubernetes.io/affinity: "cookie"
            nginx.ingress.kubernetes.io/session-cookie-name: "route"
            nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
            nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"
            nginx.ingress.kubernetes.io/proxy-body-size: "4096m"
          host: llm.app.jyje.online
          tls: true
          existingSecret: llm-letsencrypt-tls
        livenessProbe:
          httpGet:
            path: /health
            port: http
          failureThreshold: 1
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health/db
            port: http
          failureThreshold: 1
          periodSeconds: 10
        startupProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 5
          failureThreshold: 20
        persistence:
          enabled: true
          size: 10Gi
          accessModes:
            - ReadWriteMany
          storageClass: longhorn
        extraEnvVars:
          # - name: OPENAI_API_BASE_URL
          #   value: https://api.openai.com/v1
          # - name: OPENAI_API_KEY
          #   valueFrom:
          #     secretKeyRef:
          #       name: openwebui-creds
          #       key: openai.api.key
          # - name: VECTOR_DB
          #   value: milvus
          # - name: MILVUS_URI
          #   valueFrom:
          #     secretKeyRef:
          #       name: openwebui-creds
          #       key: milvus.uri
          # - name: RAG_EMBEDDING_ENGINE
          #   value: openai
          # - name: RAG_EMBEDDING_MODEL
          #   value: text-embedding-3-small
          # - name: SOCKET_LOG_LEVEL
          #   value: debug
        extraResources:
          - apiVersion: bitnami.com/v1alpha1
            kind: SealedSecret
            metadata:
              name: openwebui-creds
            spec:
              encryptedData:
                milvus.uri: AgAgdCwrfx8rgHYexif1Ul3y+dB0//cyEoP9UOxvn2jibCWxSTIKXsyo8hsy5Ui2X9jUYUPqk9HCBYwn+km6JEC7PscnNMU1X8CAkWlcuuCGKybMfZ8mxELX/ZQAF8EB8hx3NsEAFzgnkA13USyzJWbXLLII+lWXduFnCT/nfMUgrN1qkDMykHFmY2XiWEAGZbgk98WISz0/K0rl3eBSnycqjg0MbKlTkb2RakjWZfiWMPSwvc4nMkgypPnXjd1lJCiN2Omv9BGxB78P2gy/qeEtj6ABIAU+JXVuLuEkYnyWi+wBW8UuY6URnBBXX7NAS6QCwTpwp7WFj1NIRPwTT5w2nm3goHMMoW7vYWvDrnoXsWkgrjU7lTwm39FJU0psNwR6HYVFoUUYrmtpM+hMDZODSqHJjwArvWVWkeIcQvKDBdCh6xZT+UzBu/+Sm1GMToJvxUm/7s8v8RjlbEr8Q+H5CNuZsF5H45VULapTMRc226jSr7hpCDZo3KbTGYHupTfmXFo+lt4EOZZ4M2Mx9T5JrHBKm1XsYvShZDHUzGqcTNnVJiLIhtzBKGYPve4gNzARIPRPIM3awJ6qT+V04hIFy1h0mG2I492HaD6iGesL8ACr8v28TgnFdh/M5bRf+fshlFqnWg9FMz6oB2S09DOcliYtq79x688XmcE3XyiEIJF8NFaAt3VUiYnEq3VbejlbokCnlM0cMHBRwgad5yd9HsYvWrNXGgntLKvEJrYKpiVqxIE+XM3A6F4OL5XbE9XmfkJcaDxBaQLJw2k63LOdHvWw6AH0
                # openai.api.base: AgBnA9cWB5CrpkSSCdfYz47RPesujpJOsLUgiUa9EJ8BiPyRDusU4lGWl1I9hJmvfCtkeC/357nEvV2HEKZfj1Jjxcj9ltixyxPMmMXAD9gkmzMKYg8nVop8LcHJRnidCAgfpiz/MURx7+2tHbE0p7chg+eAzw9AuWUhJ1ul5uqdyZvhcaqzlB49vfHjbHd+fdD1s4EZrd+dtUOR6eODdbs5Q2CPtPFNTOiBCuJqq415bXV80mxa6nFWtd+wc5GuXD0A8VtYzhp72tvSteS44n8e6T3MwtS7UP1mSXxzmA9zerrK7NNY01lzr67Hh1AEG3rt9gTdYEgneITWUIZK3Z6ySjs4dSl4pzfSN64AczxI8oDi2xfdYV7osJMsMztnfxcDG2tKKAIxuaUCfzR7WOdvpSbENb1nT3bLdSsuNcuuV++168TD97jf1avFhLr2QtwPIu8XwnB0ZOP3J8Pk4CBMRgfLIM6Nx40XqC1s223V2v9DrD/IXb9F6WUhL7QWaVe2TfvAa+PDZDw7hGkuUKzMrk6rC3w1hiqtq37JC6FIolk7B8ZadGnJW7b7ugNJwsxR7EfGUKorKlGnbfEsaV6kR1PdNDA1OjyNr6TWLiLcylvA2aHKo++U7dUan1obsOlFPWTi5XMokLFvmFmMrPfaVo9/I0/+5llFwdxHmZV6IPZBl6EObAbICB24YcoK3sqZWArZExUKQtHb77p1mnsHoDagXEVm4mp4uKrZ8mUZ
                # openai.api.key: AgAqPK9i7CN8y8zYgrdvJUg6efv6fAqVMpJO8vtyrwbSOVdmcH8g0SpqvPWyYGCo47V5B1kgfqe2uePqpseheBCr1N2MCh7j0NRd61Q8ggHSLqRrKptr3AKztZoZmuCRInRR5GrVieh9FNvBfBS6CKUfZgwJ8iPZz0LEpTNGZJ8tE8nWlaNDI8hM8gvBClTiOC3MJHaQuXBczHPVyh0VQ10vY4wjOclXenZ88TRymO9I2LAtxD6Lws0G1oFK4UgrYMd7+azs77qn3rY3KRRvLHu0wEfMTlvEgTT9CkWJRC8xhaZYE8wzeHEnRcY5ZBZBRdUhlFUI2cx9HvX+rG33D+zZgzY1WtFI6V1ElsZtDLMykGK3eTWFPhr+pjbIzYClTqavIQmvdwsNuTjSK7cKhYx76DM6wutvQOFqzTkdAMgc51rcIrjTmLicDyPzKiinOypk1G00G71/4HJXca16gfKr3++OAfbe/d1dAKgquIUpG73JmamiRhz3dMDIEXb19cnGYD0aBoBe4fcw7teOyali4KUnv5R9SkVJ0LdCh++gz8NqJdxOs8LbXTcJHkie6CSp2BVrr7i+fLYb99KJ5iBcJbmZSfbvCU40OMQv+Y4sFYFgOu/2nRZDUkRW5vDKKKrsMhXKHCWRLkcqojls9PI4trnT+7mh5Pycdi4URT95swK9woVWSz2y7hIWuyPI4Dw7xuDA7cO647Ob+bLKF84AQn0cEZixSL1RsCs7m3pRBQ==
              template:
                metadata:
                  name: openwebui-creds
                type: Opaque
        websocket:
          enabled: true
        #   url: redis://open-webui-redis-master:6379/0
        #   redis:
        #     enabled: false
        # redis-cluster:
        #   enabled: true
  destination:
    namespace: ollama-system
    server: 'https://kubernetes.default.svc'
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated: {}
