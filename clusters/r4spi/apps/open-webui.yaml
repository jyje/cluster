apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: open-webui
spec:
  project: ai
  source:
    repoURL: https://github.com/jyje/cluster
    targetRevision: main
    path: helm/open-webui-6.6.0
    helm:
      valueFiles:
        - values.yaml
      valuesObject:
        image:
          tag: "0.6"
          pullPolicy: "Always"
        ollama:
          enabled: false
        pipelines:
          enabled: false
        ollamaUrls:
          - http://ollama:11434
        replicaCount: 3
        ingress:
          enabled: true
          class: nginx
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
            nginx.ingress.kubernetes.io/configuration-snippet: |
              more_set_headers "Access-Control-Allow-Origin: $http_origin";
            nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
            nginx.ingress.kubernetes.io/cors-allow-headers: X-Api-Key
            nginx.ingress.kubernetes.io/cors-allow-methods: HEAD
            nginx.ingress.kubernetes.io/enable-cors: "true"
            nginx.ingress.kubernetes.io/affinity: "cookie"
            nginx.ingress.kubernetes.io/session-cookie-name: "route"
            nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
            nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"
            nginx.ingress.kubernetes.io/proxy-body-size: "4096m"
          host: llm.app.jyje.online
          tls: true
          existingSecret: llm-letsencrypt-tls
        livenessProbe:
          httpGet:
            path: /health
            port: http
          failureThreshold: 1
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health/db
            port: http
          failureThreshold: 1
          periodSeconds: 10
        startupProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 5
          failureThreshold: 20
        persistence:
          enabled: true
          size: 10Gi
          accessModes:
            - ReadWriteMany
          storageClass: longhorn
        extraEnvVars:
          - name: OPENAI_API_BASE_URL
            valueFrom:
              secretKeyRef:
                name: openwebui-creds
                key: openai.api.base
          - name: OPENAI_API_KEY
            valueFrom:
              secretKeyRef:
                name: openwebui-creds
                key: openai.api.key
          - name: VECTOR_DB
            value: milvus
          - name: MILVUS_URI
            valueFrom:
              secretKeyRef:
                name: openwebui-creds
                key: milvus.uri
          - name: MILVUS_DB
            value: owui
          - name: MILVUS_TOKEN
            valueFrom:
              secretKeyRef:
                name: openwebui-creds
                key: milvus.token
          - name: RAG_EMBEDDING_ENGINE
            value: openai
          - name: RAG_EMBEDDING_MODEL
            value: text-embedding-3-small
        extraResources:
          - apiVersion: bitnami.com/v1alpha1
            kind: SealedSecret
            metadata:
              name: openwebui-creds
            spec:
              encryptedData:
                milvus.token: AgBCERl2rX+rjTBuYDooo3vPXwhqV6TU4r7XxHcZSzdsrWAdVGU0hVFC0r46xxyF0uRp4ABPvsn5mSH4tElYj/1D4tjce/5UgYyXhsO49DX3XmUmWE66YQb3VQf79endPk8FgRvLjUIKbnQXXJT0pSQ1qg4l9kq98UGVbYnoOd1xVX5TLfa5ExE4I1pycVDbPfXJdre+hvGdn5gOnc1l9Nn3PGlfXIFt1hnFMquQEaV2HgAjbrnRFytHj89b9KrrLbHwT8TMNTXQ/8JBzVl898YkzvJxtGRkaQzOGrSyshYhB7JwiYHex/7Kw1VVEcpZZlRMkcnI1iHzNq2HTpI6xnAzB7gKWh1hZlU8vu84auV8j5S4JSB09EffaePDIH3P3KDYW6leM21dEAQLiwP4jzvGNVkC5KMbSj3dkXkNb1dJd3IdgFGvOQklOgILYzz8jdIYaEFP+Q2s6axYcqVqdkHtOD/g28r9P+qpPw9uDIN4wLTAnDJfRgWfkvlsIctXi0BQ2vw+Lr5bG/1jC3WXVs+QiVUlQNIV7uALLw9/JL4uBjPBYS18nmBATrs3C41Nf2+WpB/eaBnZacKbK/yV5+w0R0hxKGcWpQ+HZGU6hQz5+2PcEki01tG1vDajp14xL4O3aPlwN5yaEMaGQJ3Xhra+Zqgwjg6fve6J+HMKyNN9grQ6aEW7cOKzr4unkGa0GautPx9P2EgZmZH0qZNwPDnnwfg=
                milvus.uri: AgBT7D1X8VRX5CxbsIACukwAwIlgBOCkBLHS0WT+HK5+BVNsRc6ChLcaS5H6UR2dZ/B0ZAv4IgZoY+m7aGr0DJTs4Cw3RrLzQyebNv+vlkQUJQ/wbGMEa5KjeG+mWNjvy22hoC94cJf2MihdanUKXQK8Gg5ARzb6T4/GrPdF3oXWJwBtB5PvFar3oeAIan8ua7WTMJQd6dhq2LjlEbHH1G7idPND5h5IJvicRieGqZsZTuvqglNyh/8z0WITi61qoPkt9l9X3/em4dfJUtIw8DakICr2kWvkeBr4HGyM/5HwCWmYvO1cr8K/9atrM+PdbloQkQTxbwqrH3T7T58E99gp5M88tJWWrnHk+V/OhHx23gF1WZ533MVbh4o3NQLRQHWF+2cEcbWDbPE6PsMrMM5P1hCNLvimOgie6bWHVBmZwC4/BiTxAA+DgdJv5x2dgbC+IEt7X0MGchWZSsofbsKrRMZvc9MSPnGhVUnWsOTd1gs4FdxI2YMK/qVFyqzyniAqH/FwzkJqjhLQtkaNlIY3gkrsI5p1naWH6bm5ZAH8VDv+gEyNTox775Dgeqmx+9CNc2K2z6b/o3Zwo0szNlsetpUzKVNzbwi8+O7o3SvSa/jl7draHeSyp/1ihbMabE3Zi+affgeMFOR1iamxJgPni6y8L9/UvAzcYrXObtyaAB/eDtQYVT0vjtAFn6eIVT34Cx6RoAuFqcu3HcoWrpHuYp8W3zbpHGA4zzb8Zkmq5WGM/1XvgnGrB1Hz2W2SUU1JlPwU
                openai.api.base: AgCejEnk4Fu9Tp4phyL9eaVkVjpBSzvEbwwwnUsf/ER8ZCYszoIQqI2JehyMSP1CLFoy8Mo9ZIzIsFJu+qtEMVNl8C+Mun3PKapAvwKl8sf5d4wK4zOn1gWP+fm9e0aZ8PtkDoE2LFCLDvu/fI0PkZRSv5STEocPsxshnsn0S8bwZ6riuvTXfdUsZFGFsh1eugwcH824oHCqx5adnDjYQfdWVUHHwBg8k2sufSEpoomz8JKJXxDRzIoJDEm1rqDXEL4CMx2+fVx0U7/LM8VRscBVOq/cr4Xoc3tlI2NDqbd6qL6wwwWtUuJgQkztYQjT4UtW3MsQCJYo2Hm+8PbBMPHHU+mOahc2bQ6m8rOrRX+TYPH+tTAIl+QnknCUQVaTE4LhF/plKJSa0vSftg6dZO5mGIPlELtbvykzVp1CzjH0WS3mgGK6/PGu7q3SJoBM79RPcKJ9zN3Tx9zsrqGuLmjjBbwv3nRWTCiZpgwr71C49JIiR1WhssGMTOHxCGB7ZWdTOsd2GnDFkM60tKI6csjx669T2iFQvQd6DixL29RiTWwmObZR/gO/pMZYcWW80ha4dgSqB0AO2iuHv8hZu71Jgy+ct69jtlGtDSI3J66/dsa8ODH4LOPGR3RNl0UkZ5F75CC0M5+Lbwj8KHn6yoJaxVbiuR0NNoYRIx6HC35m5o+ePXgfixg1HWuC3Uty+e4ffnN9ZhYDWeJScsnSAcrEAnyWlad3Nki+
                openai.api.key: AgAGcbQrvDgT2DB+LQ8NV6xfP8raS9GDIMosCmXLQjL5MHYUKt4HOBqVikCxuulFPToHV3YEPAw36fG+N8xqWE8axHq57e2IxhLXNQh+Gr65Exf8Z0DlXQYmJ5TC4ZJqJwzY1lSbLY0RmP8OLPoyLqtrEhfvX4kOKaUfmHDC8NC1OoJtcaxOehlOSbIW0BYqZfd/ICe0kPNXUtmSBY2KC+EqDyGP9jPrwUn1c1lpNHdd20jRfRgHNdn8yLBDifd7lte5JE0V1PG9lNhmEOGHsbBDkthe2Ex8XmI145CUh8tdgnxzfrICRmAv/np47SU5CW/2epRxHQiN0dvji0Y8sVVD3TXtqjKaRTKJvXVDgNoDXwR/YVybmgi8o0v1+p7Zm3+GDL9tH6Nni8v4rhWTSKGLMCbmPtHqUA4kLfz3AZfWj7rsEOjUgl5fyGCuootlj5RYe9crCDJ69Yb5LuTlrNbYdbPOn1wJAHKCYN8FcugugNGF2tM4oDcOvCHt/VMHRUCdh0ehizqpKg3WkyFBX2Ns0TI4Do1ZKr6Rm8nsB41QonBvsrKHXvy7p19JHhrDd7jrg5G4xTXauLqShtACMTKPD3vYPYifumLJSzFnqdf1xrfdzOCyTYme8vOIvw12aSLGkB+bPtRQzKXUQ8sRa1eKi5EZCMzO48bt1t/FOy2ZOrM8WNMbzekovimhNbWrSFabnjFIiCaFm4UihMg2ybysWQAPo509c0dZZ5X2dR4Wx1bjU5QsuqkPQ34/5cWp2q2F6xwMm5q93p0qXJYT/rL3ldqXoV6fzy3OnjCgbXy1u9YLiZwV00T1J12LWy35AdS1osHU5ykx7bGaNaHliH0HtD6GzQxDih5Idug4fiYI631D7k94Rs8QG6CP4Z7H4diIVwL8z5iMLohNUK264gI3Yv6zSw==
              template:
                metadata:
                  name: openwebui-creds
                type: Opaque
        websocket:
          enabled: true
        #   url: redis://open-webui-redis-master:6379/0
        #   redis:
        #     enabled: false
        # redis-cluster:
        #   enabled: true
  destination:
    namespace: ollama-system
    server: 'https://kubernetes.default.svc'
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated: {}
